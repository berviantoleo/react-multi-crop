import t,{Component as e}from"react";import{fabric as o}from"fabric";import r from"@material-ui/core/Button";import i from"@material-ui/core/Grid";function n(t){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */var a,s=function(t,e){return(s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o])})(t,e)};function c(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function o(){this.constructor=t}s(t,e),t.prototype=null===e?Object.create(e):(o.prototype=e.prototype,new o)}var l=new Uint8Array(16);function d(){if(!a&&!(a="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return a(l)}var h=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function p(t){return"string"==typeof t&&h.test(t)}for(var u=[],f=0;f<256;++f)u.push((f+256).toString(16).substr(1));function v(t,e,o){var r=(t=t||{}).random||(t.rng||d)();if(r[6]=15&r[6]|64,r[8]=63&r[8]|128,e){o=o||0;for(var i=0;i<16;++i)e[o+i]=r[i];return e}return function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=(u[t[e+0]]+u[t[e+1]]+u[t[e+2]]+u[t[e+3]]+"-"+u[t[e+4]]+u[t[e+5]]+"-"+u[t[e+6]]+u[t[e+7]]+"-"+u[t[e+8]]+u[t[e+9]]+"-"+u[t[e+10]]+u[t[e+11]]+u[t[e+12]]+u[t[e+13]]+u[t[e+14]]+u[t[e+15]]).toLowerCase();if(!p(o))throw TypeError("Stringified UUID is invalid");return o}(r)}var m=function(t){function e(e){var o=t.call(this,e)||this;return o.id=null,o.objectId="",e&&(o.id=e.id,o.objectId=e.objectId),o}return c(e,t),e}(o.Rect),g=function(e){function a(t){var o=e.call(this,t)||this;return o.REGEXP_ORIGINS=/^(\w+:)\/\/([^:/?#]*):?(\d*)/i,o.state={canvas:null,initial:!0},o.color=t.cropBackgroundColor||"yellow",o.opacity=t.cropBackgroundOpacity||.5,o.keyboardHandler=o.keyboardHandler.bind(o),o.addNew=o.addNew.bind(o),o.deleteShapes=o.deleteShapes.bind(o),o.multiSelect=o.multiSelect.bind(o),o.discardActiveObject=o.discardActiveObject.bind(o),o}return c(a,e),a.prototype.componentDidMount=function(){this.state.canvas||this.initialCanvas()},a.prototype.componentDidUpdate=function(t){var e=this.state.canvas;if(e){var o=this.props,r=o.zoomLevel,i=o.activeObject;if(t.zoomLevel!==r&&r&&r>0&&(e.setZoom(r),e.renderAll()),t.activeObject!==i&&i){console.log(i);var n=e.getObjects().filter((function(t){return t.objectId===i}));e.discardActiveObject();for(var a=0,s=n;a<s.length;a++){var c=s[a];e.setActiveObject(c)}e.requestRenderAll()}}},a.prototype.changeImage=function(){var t=this.state.canvas;t&&(t.backgroundImage||this.initialImage())},a.prototype.loadImage=function(t){var e=this.state,o=e.initial,r=e.canvas;if(r&&r.width&&r.height&&t.height&&t.width){var i=this.props.zoomLevel,n=t.height/t.width,a=r.width*n;r.setHeight(a),i?r.setZoom(i):r.setZoom(r.width/t.width),r.setBackgroundImage(t,r.renderAll.bind(r)),"boolean"==typeof o&&o&&this.setState({initial:!1},this.initialObjects.bind(this))}},a.prototype.isCrossOriginURL=function(t){var e=t.match(this.REGEXP_ORIGINS);return null!==e&&(e[1]!==window.location.protocol||e[2]!==window.location.hostname||e[3]!==window.location.port)},a.prototype.initialImage=function(){var t=this.props,e=t.record,r=t.image,i=this.loadImage.bind(this);if("object"===n(e)&&e.image){var a={};this.isCrossOriginURL(e.image)&&(a.crossOrigin="Anonymous"),o.Image.fromURL(e.image,i,a)}else if("string"==typeof r){a={};this.isCrossOriginURL(r)&&(a.crossOrigin="Anonymous"),o.Image.fromURL(r,i,a)}},a.prototype.initialObjects=function(){var t=this.state.canvas;if(t){var e=this.props,o=e.record,r=e.readonly,i=e.borderColor,a=e.cornerColor,s=e.cornerSize,c=e.transparentCorners;if(o){var l=o.clippings;if(Array.isArray(l)&&l.length>0&&"object"===n(l[0])){for(var d={borderColor:i,cornerColor:a,cornerSize:s,transparentCorners:c},h=0,p=0,u=l;p<u.length;p++){var f=u[p],v=this.createObject(t,f,d,r||!1);v&&(t.add(v),h+=1)}h>0&&this.setOutput()}}else console.log("Not have any record. Skipped.")}},a.prototype.zoom=function(t){var e=this.state.canvas;if(e){var o=t.e.deltaY,r=e.getZoom();(r*=Math.pow(.999,o))>20&&(r=20),r<.01&&(r=.01),e.setZoom(r),t.e.preventDefault(),t.e.stopPropagation();var i=this.props.zoomChanged;i&&i(r)}},a.prototype.mouseHover=function(t){var e=this.props.onHover,o=this.shapetoStructureData.bind(this),r=t.target;r&&"rect"===r.type&&e&&e(o(r))},a.prototype.mouseOut=function(t){var e=this.props.onHover,o=t.target;o&&"rect"===o.type&&e&&e(null)},a.prototype.selectionHandler=function(t){var e=this.props.onSelect,o=this.shapetoStructureData.bind(this),r=t.target;r&&"rect"===r.type&&e&&e(o(r))},a.prototype.selectionClearHandler=function(){var t=this.props.onSelect;t&&t(null)},a.prototype.initialCanvas=function(){var t=this.props,e=t.id,r=t.width,i=t.height,n=t.readonly,a=new o.Canvas(e||"canvas",{width:r,height:i});if(n){a.selectionKey=void 0;var s=this.mouseHover.bind(this),c=this.mouseOut.bind(this),l=this.selectionHandler.bind(this),d=this.selectionClearHandler.bind(this);a.on("mouse:over",s),a.on("mouse:out",c),a.on("selection:created",l),a.on("selection:updated",l),a.on("selection:cleared",d)}else{var h=this.doubleClickEvent.bind(this),p=this.setOutput.bind(this);a.on("mouse:dblclick",h),a.on("object:modified",p)}var u=this.zoom.bind(this);a.on("mouse:wheel",u),a.on("mouse:down",(function(t){var e=t.e;!0===e.altKey&&(this.isDragging=!0,this.selection=!1,this.lastPosX=e.clientX,this.lastPosY=e.clientY)})),a.on("mouse:move",(function(t){if(this.isDragging){var e=t.e,o=this.viewportTransform;o[4]+=e.clientX-this.lastPosX,o[5]+=e.clientY-this.lastPosY,this.requestRenderAll(),this.lastPosX=e.clientX,this.lastPosY=e.clientY}})),a.on("mouse:up",(function(){this.setViewportTransform(this.viewportTransform),this.isDragging=!1,this.selection=!0})),this.setState({canvas:a},this.initialImage.bind(this))},a.prototype.addNew=function(){var t=this.state.canvas;if(t){var e=this.props,o={borderColor:e.borderColor,cornerColor:e.cornerColor,cornerSize:e.cornerSize,transparentCorners:e.transparentCorners},r=this.createObject(t,{id:null,rect:{x1:0,y1:0,x2:.2,y2:.2}},o,!1);r&&(t.add(r),this.setOutput())}},a.prototype.doubleClickEvent=function(t){var e=this.state.canvas;if(e){var o=this.props,r=o.readonly,i=o.borderColor,n=o.cornerColor,a=o.cornerSize,s=o.transparentCorners;if(t&&t.target){var c=t.target.left,l=t.target.top,d=t.target.width,h=t.target.height,p={left:c+50,top:l+50,width:d*t.target.scaleX,height:h*t.target.scaleY,borderColor:i,cornerColor:n,cornerSize:a,transparentCorners:s},u=this.createObjectByAttribute(p,r||!1);e.add(u),e.discardActiveObject(),e.setActiveObject(u),e.requestRenderAll(),this.setOutput()}else if(t&&t.pointer){p={left:c=t.absolutePointer.x,top:t.absolutePointer.y,width:100,height:100,borderColor:i,cornerColor:n,cornerSize:a,transparentCorners:s},u=this.createObjectByAttribute(p,r||!1);e.add(u),e.discardActiveObject(),e.setActiveObject(u),e.requestRenderAll(),this.setOutput()}}},a.prototype.createObjectByAttribute=function(t,e){return new m({left:t.left,top:t.top,width:t.width,height:t.height,borderColor:t.borderColor,cornerColor:t.cornerColor,cornerSize:t.cornerSize,transparentCorners:t.transparentCorners,fill:this.color,opacity:this.opacity,id:null,strokeWidth:0,strokeUniform:!0,lockRotation:!0,lockMovementX:e,lockMovementY:e,lockScalingX:e,lockScalingY:e,objectId:v()})},a.prototype.shapetoStructureData=function(t){var e=this.state.canvas;if(!e||!e.backgroundImage)return null;var r=e.backgroundImage;if(!(r instanceof o.Image))return null;if(void 0===t.left||void 0===t.top||void 0===t.width||void 0===t.height||void 0===t.scaleX||void 0===t.scaleY||void 0===r.width||void 0===r.height)return null;var i=this.props,n=i.includeDataUrl,a=i.includeHtmlCanvas,s=t.left/r.width,c=t.top/r.height,l=(t.left+t.width*t.scaleX)/r.width,d=(t.top+t.height*t.scaleY)/r.height,h={x1:s,y1:c,x2:l,y2:d},p={id:t.id,objectId:t.objectId,rect:JSON.stringify(h)};if(n){var u=null;try{u=r.toDataURL({height:t.getScaledHeight(),width:t.getScaledWidth(),left:t.left,top:t.top,format:"jpeg"})}catch(t){console.error(t)}p.dataUrl=u}if(a){var f=null;try{f=r.toCanvasElement({height:t.getScaledHeight(),width:t.getScaledWidth(),left:t.left,top:t.top})}catch(t){console.error(t)}p.canvasElement=f}var v=r.width,m=r.height,g=s*v,y=l*v,b=c*m,w=d*m,C={x:g,y:b,x2:y,y2:w,w:y-g,h:w-b,boundX:v,boundY:m};return p.crop=JSON.stringify(C),p.deletedAt="-1",p},a.prototype.deleteShapes=function(){var t=this.props.readonly,e=this.state.canvas;e&&!t&&(e.getActiveObjects().forEach((function(t){e.remove(t)})),this.setOutput())},a.prototype.setOutput=function(){var t=this.state.canvas;if(t){var e=this.shapetoStructureData.bind(this),o=[];t.getObjects("rect").forEach((function(t){var r=e(t);r&&o.push(r)}));var r=this.props.input;r&&r.onChange(o)}},a.prototype.createObject=function(t,e,r,i){if(!t||!t.backgroundImage)return null;var n,a=t.backgroundImage;if(!(a instanceof o.Image))return null;if(!a.width||!a.height)return null;n="string"==typeof e.rect?JSON.parse(e.rect):e.rect;var s=a.width*n.x1,c=a.height*n.y1,l=a.width*n.x2,d=a.height*n.y2;return new m({left:s,top:c,width:l-s,height:d-c,fill:this.color,opacity:this.opacity,id:e.id,strokeWidth:0,strokeUniform:!0,lockRotation:!0,hasBorders:!1,lockMovementX:i,lockMovementY:i,lockScalingX:i,lockScalingY:i,borderColor:r.borderColor,cornerColor:r.cornerColor,cornerSize:r.cornerSize,transparentCorners:r.transparentCorners,objectId:v()})},a.prototype.multiSelect=function(){var t=this.props.readonly,e=this.state.canvas;if(e&&!t){e.discardActiveObject();var r=new o.ActiveSelection(e.getObjects(),{canvas:e});e.setActiveObject(r),e.requestRenderAll()}else console.log("Canvas not defined")},a.prototype.discardActiveObject=function(){var t=this.state.canvas;t?(t.discardActiveObject(),t.requestRenderAll()):console.log("Canvas not defined")},a.prototype.keyboardHandler=function(t){if(!t.defaultPrevented){var e=!1,o=t.key||t.keyCode;"Delete"===o||46===o?(this.deleteShapes(),e=!0):!t.ctrlKey||65!==o&&"a"!==o||(this.multiSelect(),e=!0),e&&t.preventDefault()}},a.prototype.render=function(){var e,o=this.props,n=o.input,a=o.source,s=o.showLabel,c=o.showButton,l=o.id,d=o.width,h=o.height,p=o.readonly,u=!!n,f=a;n&&(e=n.value,f=n.name);return t.createElement("div",{id:"canvas-wrapper"},s&&t.createElement("div",{className:"label"},f),t.createElement(i,{container:!0,direction:"row",justify:"flex-start",alignItems:"flex-start"},t.createElement(i,{item:!0,xs:!0,onKeyDown:p?void 0:this.keyboardHandler,tabIndex:0},t.createElement("canvas",{id:l,width:d,height:h,style:{border:"0px solid #aaa"}})),c&&!p&&t.createElement(i,{container:!0,item:!0,xs:!0,direction:"column",justify:"flex-start",alignItems:"flex-start"},t.createElement(i,{item:!0,xs:!0},t.createElement(r,{variant:"contained",id:"addmore",color:"primary",onClick:this.addNew},"Add More Shapes")),t.createElement(i,{item:!0,xs:!0},t.createElement(r,{variant:"contained",id:"deleteselected",color:"primary",onClick:this.deleteShapes},"Delete Selected Object")),t.createElement(i,{item:!0,xs:!0},t.createElement(r,{variant:"contained",id:"multiselect",color:"primary",onClick:this.multiSelect},"Select All")),t.createElement(i,{item:!0,xs:!0},t.createElement(r,{variant:"contained",id:"discard",color:"primary",onClick:this.discardActiveObject},"Discard Selection"))),u&&t.createElement("input",{type:"hidden",value:e})))},a.defaultProps={id:"canvas",width:800,height:800,input:void 0,source:"react-crop-form",record:{image:void 0,clippings:[]},image:void 0,cropBackgroundColor:"yellow",cropBackgroundOpacity:.5,readonly:!1,borderColor:"black",cornerColor:"black",cornerSize:13,transparentCorners:!0,showLabel:!1,showButton:!1,includeDataUrl:!1,includeHtmlCanvas:!1,zoomChanged:void 0},a}(e);export{g as ReactMultiCrop};
