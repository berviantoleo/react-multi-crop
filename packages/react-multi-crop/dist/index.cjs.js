"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("react"),e=require("fabric"),r=require("@material-ui/core/Button"),o=require("@material-ui/core/Grid"),i=require("uuid");function n(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var a=n(t),s=n(r),c=n(o);function l(t){return(l="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */var d=function(t,e){return(d=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])})(t,e)};function u(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function r(){this.constructor=t}d(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}var h=function(t){function e(e){var r=t.call(this,e)||this;return r.id=null,r.objectId="",e&&(r.id=e.id,r.objectId=e.objectId),r}return u(e,t),e}(e.fabric.Rect),p=function(t){function r(e){var r=t.call(this,e)||this;return r.REGEXP_ORIGINS=/^(\w+:)\/\/([^:/?#]*):?(\d*)/i,r.state={canvas:null,initial:!0},r.color=e.cropBackgroundColor||"yellow",r.opacity=e.cropBackgroundOpacity||.5,r.keyboardHandler=r.keyboardHandler.bind(r),r.addNew=r.addNew.bind(r),r.deleteShapes=r.deleteShapes.bind(r),r.multiSelect=r.multiSelect.bind(r),r.discardActiveObject=r.discardActiveObject.bind(r),r}return u(r,t),r.prototype.componentDidMount=function(){this.state.canvas||this.initialCanvas()},r.prototype.componentDidUpdate=function(t){var e=this.state.canvas;if(e){var r=this.props,o=r.zoomLevel,i=r.activeObject;if(t.zoomLevel!==o&&o&&o>0&&(e.setZoom(o),e.renderAll()),t.activeObject!==i&&i){console.log(i);var n=e.getObjects().filter((function(t){return t.objectId===i}));e.discardActiveObject();for(var a=0,s=n;a<s.length;a++){var c=s[a];e.setActiveObject(c)}e.requestRenderAll()}}},r.prototype.changeImage=function(){var t=this.state.canvas;t&&(t.backgroundImage||this.initialImage())},r.prototype.loadImage=function(t){var e=this.state,r=e.initial,o=e.canvas;if(o&&o.width&&o.height&&t.height&&t.width){var i=this.props.zoomLevel,n=t.height/t.width,a=o.width*n;o.setHeight(a),i?o.setZoom(i):o.setZoom(o.width/t.width),o.setBackgroundImage(t,o.renderAll.bind(o)),"boolean"==typeof r&&r&&this.setState({initial:!1},this.initialObjects.bind(this))}},r.prototype.isCrossOriginURL=function(t){var e=t.match(this.REGEXP_ORIGINS);return null!==e&&(e[1]!==window.location.protocol||e[2]!==window.location.hostname||e[3]!==window.location.port)},r.prototype.initialImage=function(){var t=this.props,r=t.record,o=t.image,i=this.loadImage.bind(this);if("object"===l(r)&&r.image){var n={};this.isCrossOriginURL(r.image)&&(n.crossOrigin="Anonymous"),e.fabric.Image.fromURL(r.image,i,n)}else if("string"==typeof o){n={};this.isCrossOriginURL(o)&&(n.crossOrigin="Anonymous"),e.fabric.Image.fromURL(o,i,n)}},r.prototype.initialObjects=function(){var t=this.state.canvas;if(t){var e=this.props,r=e.record,o=e.readonly,i=e.borderColor,n=e.cornerColor,a=e.cornerSize,s=e.transparentCorners;if(r){var c=r.clippings;if(Array.isArray(c)&&c.length>0&&"object"===l(c[0])){for(var d={borderColor:i,cornerColor:n,cornerSize:a,transparentCorners:s},u=0,h=0,p=c;h<p.length;h++){var f=p[h],v=this.createObject(t,f,d,o||!1);v&&(t.add(v),u+=1)}u>0&&this.setOutput()}}else console.log("Not have any record. Skipped.")}},r.prototype.zoom=function(t){var e=this.state.canvas;if(e){var r=t.e.deltaY,o=e.getZoom();(o*=Math.pow(.999,r))>20&&(o=20),o<.01&&(o=.01),e.setZoom(o),t.e.preventDefault(),t.e.stopPropagation();var i=this.props.zoomChanged;i&&i(o)}},r.prototype.mouseHover=function(t){var e=this.props.onHover,r=this.shapetoStructureData.bind(this),o=t.target;o&&"rect"===o.type&&e&&e(r(o))},r.prototype.mouseOut=function(t){var e=this.props.onHover,r=t.target;r&&"rect"===r.type&&e&&e(null)},r.prototype.selectionHandler=function(t){var e=this.props.onSelect,r=this.shapetoStructureData.bind(this),o=t.target;o&&"rect"===o.type&&e&&e(r(o))},r.prototype.selectionClearHandler=function(){var t=this.props.onSelect;t&&t(null)},r.prototype.initialCanvas=function(){var t=this.props,r=t.id,o=t.width,i=t.height,n=t.readonly,a=new e.fabric.Canvas(r||"canvas",{width:o,height:i});if(n){a.selectionKey=void 0;var s=this.mouseHover.bind(this),c=this.mouseOut.bind(this),l=this.selectionHandler.bind(this),d=this.selectionClearHandler.bind(this);a.on("mouse:over",s),a.on("mouse:out",c),a.on("selection:created",l),a.on("selection:updated",l),a.on("selection:cleared",d)}else{var u=this.doubleClickEvent.bind(this),h=this.setOutput.bind(this);a.on("mouse:dblclick",u),a.on("object:modified",h)}var p=this.zoom.bind(this);a.on("mouse:wheel",p),a.on("mouse:down",(function(t){var e=t.e;!0===e.altKey&&(this.isDragging=!0,this.selection=!1,this.lastPosX=e.clientX,this.lastPosY=e.clientY)})),a.on("mouse:move",(function(t){if(this.isDragging){var e=t.e,r=this.viewportTransform;r[4]+=e.clientX-this.lastPosX,r[5]+=e.clientY-this.lastPosY,this.requestRenderAll(),this.lastPosX=e.clientX,this.lastPosY=e.clientY}})),a.on("mouse:up",(function(){this.setViewportTransform(this.viewportTransform),this.isDragging=!1,this.selection=!0})),this.setState({canvas:a},this.initialImage.bind(this))},r.prototype.addNew=function(){var t=this.state.canvas;if(t){var e=this.props,r={borderColor:e.borderColor,cornerColor:e.cornerColor,cornerSize:e.cornerSize,transparentCorners:e.transparentCorners},o=this.createObject(t,{id:null,rect:{x1:0,y1:0,x2:.2,y2:.2}},r,!1);o&&(t.add(o),this.setOutput())}},r.prototype.doubleClickEvent=function(t){var e=this.state.canvas;if(e){var r=this.props,o=r.readonly,i=r.borderColor,n=r.cornerColor,a=r.cornerSize,s=r.transparentCorners;if(t&&t.target){var c=t.target.left,l=t.target.top,d=t.target.width,u=t.target.height,h={left:c+50,top:l+50,width:d*t.target.scaleX,height:u*t.target.scaleY,borderColor:i,cornerColor:n,cornerSize:a,transparentCorners:s},p=this.createObjectByAttribute(h,o||!1);e.add(p),e.discardActiveObject(),e.setActiveObject(p),e.requestRenderAll(),this.setOutput()}else if(t&&t.pointer){h={left:c=t.absolutePointer.x,top:t.absolutePointer.y,width:100,height:100,borderColor:i,cornerColor:n,cornerSize:a,transparentCorners:s},p=this.createObjectByAttribute(h,o||!1);e.add(p),e.discardActiveObject(),e.setActiveObject(p),e.requestRenderAll(),this.setOutput()}}},r.prototype.createObjectByAttribute=function(t,e){return new h({left:t.left,top:t.top,width:t.width,height:t.height,borderColor:t.borderColor,cornerColor:t.cornerColor,cornerSize:t.cornerSize,transparentCorners:t.transparentCorners,fill:this.color,opacity:this.opacity,id:null,strokeWidth:0,strokeUniform:!0,lockRotation:!0,lockMovementX:e,lockMovementY:e,lockScalingX:e,lockScalingY:e,objectId:i.v4()})},r.prototype.shapetoStructureData=function(t){var r=this.state.canvas;if(!r||!r.backgroundImage)return null;var o=r.backgroundImage;if(!(o instanceof e.fabric.Image))return null;if(void 0===t.left||void 0===t.top||void 0===t.width||void 0===t.height||void 0===t.scaleX||void 0===t.scaleY||void 0===o.width||void 0===o.height)return null;var i=this.props,n=i.includeDataUrl,a=i.includeHtmlCanvas,s=t.left/o.width,c=t.top/o.height,l=(t.left+t.width*t.scaleX)/o.width,d=(t.top+t.height*t.scaleY)/o.height,u={x1:s,y1:c,x2:l,y2:d},h={id:t.id,objectId:t.objectId,rect:JSON.stringify(u)};if(n){var p=null;try{p=o.toDataURL({height:t.getScaledHeight(),width:t.getScaledWidth(),left:t.left,top:t.top,format:"jpeg"})}catch(t){console.error(t)}h.dataUrl=p}if(a){var f=null;try{f=o.toCanvasElement({height:t.getScaledHeight(),width:t.getScaledWidth(),left:t.left,top:t.top})}catch(t){console.error(t)}h.canvasElement=f}var v=o.width,g=o.height,m=s*v,b=l*v,y=c*g,C=d*g,w={x:m,y:y,x2:b,y2:C,w:b-m,h:C-y,boundX:v,boundY:g};return h.crop=JSON.stringify(w),h.deletedAt="-1",h},r.prototype.deleteShapes=function(){var t=this.props.readonly,e=this.state.canvas;e&&!t&&(e.getActiveObjects().forEach((function(t){e.remove(t)})),this.setOutput())},r.prototype.setOutput=function(){var t=this.state.canvas;if(t){var e=this.shapetoStructureData.bind(this),r=[];t.getObjects("rect").forEach((function(t){var o=e(t);o&&r.push(o)}));var o=this.props.input;o&&o.onChange(r)}},r.prototype.createObject=function(t,r,o,n){if(!t||!t.backgroundImage)return null;var a,s=t.backgroundImage;if(!(s instanceof e.fabric.Image))return null;if(!s.width||!s.height)return null;a="string"==typeof r.rect?JSON.parse(r.rect):r.rect;var c=s.width*a.x1,l=s.height*a.y1,d=s.width*a.x2,u=s.height*a.y2;return new h({left:c,top:l,width:d-c,height:u-l,fill:this.color,opacity:this.opacity,id:r.id,strokeWidth:0,strokeUniform:!0,lockRotation:!0,hasBorders:!1,lockMovementX:n,lockMovementY:n,lockScalingX:n,lockScalingY:n,borderColor:o.borderColor,cornerColor:o.cornerColor,cornerSize:o.cornerSize,transparentCorners:o.transparentCorners,objectId:i.v4()})},r.prototype.multiSelect=function(){var t=this.props.readonly,r=this.state.canvas;if(r&&!t){r.discardActiveObject();var o=new e.fabric.ActiveSelection(r.getObjects(),{canvas:r});r.setActiveObject(o),r.requestRenderAll()}else console.log("Canvas not defined")},r.prototype.discardActiveObject=function(){var t=this.state.canvas;t?(t.discardActiveObject(),t.requestRenderAll()):console.log("Canvas not defined")},r.prototype.keyboardHandler=function(t){if(!t.defaultPrevented){var e=!1,r=t.key||t.keyCode;"Delete"===r||46===r?(this.deleteShapes(),e=!0):!t.ctrlKey||65!==r&&"a"!==r||(this.multiSelect(),e=!0),e&&t.preventDefault()}},r.prototype.render=function(){var t,e=this.props,r=e.input,o=e.source,i=e.showLabel,n=e.showButton,l=e.id,d=e.width,u=e.height,h=e.readonly,p=!!r,f=o;r&&(t=r.value,f=r.name);return a.default.createElement("div",{id:"canvas-wrapper"},i&&a.default.createElement("div",{className:"label"},f),a.default.createElement(c.default,{container:!0,direction:"row",justify:"flex-start",alignItems:"flex-start"},a.default.createElement(c.default,{item:!0,xs:!0,onKeyDown:h?void 0:this.keyboardHandler,tabIndex:0},a.default.createElement("canvas",{id:l,width:d,height:u,style:{border:"0px solid #aaa"}})),n&&!h&&a.default.createElement(c.default,{container:!0,item:!0,xs:!0,direction:"column",justify:"flex-start",alignItems:"flex-start"},a.default.createElement(c.default,{item:!0,xs:!0},a.default.createElement(s.default,{variant:"contained",id:"addmore",color:"primary",onClick:this.addNew},"Add More Shapes")),a.default.createElement(c.default,{item:!0,xs:!0},a.default.createElement(s.default,{variant:"contained",id:"deleteselected",color:"primary",onClick:this.deleteShapes},"Delete Selected Object")),a.default.createElement(c.default,{item:!0,xs:!0},a.default.createElement(s.default,{variant:"contained",id:"multiselect",color:"primary",onClick:this.multiSelect},"Select All")),a.default.createElement(c.default,{item:!0,xs:!0},a.default.createElement(s.default,{variant:"contained",id:"discard",color:"primary",onClick:this.discardActiveObject},"Discard Selection"))),p&&a.default.createElement("input",{type:"hidden",value:t})))},r.defaultProps={id:"canvas",width:800,height:800,input:void 0,source:"react-crop-form",record:{image:void 0,clippings:[]},image:void 0,cropBackgroundColor:"yellow",cropBackgroundOpacity:.5,readonly:!1,borderColor:"black",cornerColor:"black",cornerSize:13,transparentCorners:!0,showLabel:!1,showButton:!1,includeDataUrl:!1,includeHtmlCanvas:!1,zoomChanged:void 0},r}(t.Component);exports.ReactMultiCrop=p;
